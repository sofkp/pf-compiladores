<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compilador</title>
    <style>
        :root { --bg: #1e1e1e; --panel: #252526; --text: #d4d4d4; --accent: #007acc; --err: #f48771; --success: #89d185; }
        body { font-family: 'Segoe UI', Consolas, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        
        .top-section { display: flex; gap: 20px; height: 35%; margin-bottom: 20px; }
        .input-area { flex: 1; display: flex; flex-direction: column; }
        textarea { flex: 1; background: var(--panel); color: #9cdcfe; border: 1px solid #444; font-family: 'Consolas'; padding: 10px; resize: none; border-radius: 5px; }
        .log-area { flex: 1; background: #111; border: 1px solid #444; padding: 10px; font-family: monospace; overflow-y: auto; color: #ccc; border-radius: 5px;}
        
        .toolbar { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        button { padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-compile { background: var(--accent); color: white; }
        .btn-compile:hover { background: #005f9e; }
        .btn-step { background: var(--success); color: #1e1e1e; }
        .btn-step:disabled { background: #555; cursor: not-allowed; }

        .debug-container { display: grid; grid-template-columns: 1fr 300px 350px; gap: 20px; flex-grow: 1; height: 50%; overflow: hidden; }
        .panel { background-color: var(--panel); border-radius: 8px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { background: #333; padding: 8px 12px; font-weight: bold; border-bottom: 1px solid #444; font-size: 0.9em; display: flex; justify-content: space-between; }
        
        .panel-content { padding: 0; overflow-y: auto; flex-grow: 1; }
        
        .instruction { padding: 2px 8px; font-family: 'Consolas'; font-size: 0.9em; border-bottom: 1px solid #2d2d2d; }
        .instruction.active { background-color: #264f78; color: white; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        td, th { padding: 4px 8px; border-bottom: 1px solid #333; text-align: left; }
        th { color: var(--accent); }
        .changed { color: var(--success); font-weight: bold; }
        .reg-name { color: #569cd6; font-weight: bold; }
    </style>
</head>
<body>

    <div class="toolbar">
        <h2 style="margin:0; margin-right: 20px;">Compilador</h2>
        <button class="btn-compile" onclick="compileCode()">Compilar Código</button>
        <button class="btn-step" id="btnStep" onclick="step()" disabled>Ejecutar Paso a Paso</button>
        <span id="statusText" style="margin-left: auto; font-style: italic; color: #888;">Listo.</span>
    </div>

    <div class="top-section">
        <div class="input-area">
            <div style="margin-bottom: 5px; font-weight: bold;">Código Fuente (RUST):</div>
            <textarea id="sourceInput" spellcheck="false">
fn main() {
    let a = 10 + 20 * 3 - (4 * 5);
    if (a * 3 == 24) {
        println!(1);
    } else {
        println!(2);
    }
}
            </textarea>
        </div>
        <div class="input-area">
            <div style="margin-bottom: 5px; font-weight: bold;">Log del Compilador:</div>
            <div id="compilerLog" class="log-area">Esperando compilación...</div>
        </div>
    </div>

    <div class="debug-container">
        <div class="panel">
            <div class="panel-header">ASM Generado</div>
            <div class="panel-content" id="asmContainer"></div>
        </div>

        <div class="panel">
            <div class="panel-header">Registros</div>
            <div class="panel-content">
                <table id="regTable"><thead><tr><th>Reg</th><th>Valor</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">Memoria (Stack) & Consola</div>
            <div class="panel-content">
                <div style="padding: 10px; border-bottom: 1px solid #444;">
                    <strong style="color:var(--success)">Salida del programa:</strong>
                    <div id="progOutput" style="font-family: monospace; min-height: 20px;"></div>
                </div>
                <table id="memTable"><thead><tr><th>Addr</th><th>Val</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>

    <script>
        let currentRegs = {};

        async function compileCode() {
            const code = document.getElementById('sourceInput').value;
            const logDiv = document.getElementById('compilerLog');
            const btnStep = document.getElementById('btnStep');
            
            logDiv.innerText = "Compilando...";
            logDiv.style.color = "#ccc";
            document.getElementById('statusText').innerText = "Compilando...";
            btnStep.disabled = true;

            try {
                const res = await fetch('/compile', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code})
                });
                const data = await res.json();

                if (!res.ok){
                    logDiv.innerText = "Error del servidor: " + (data.msg || res.statusText);
                    logDiv.style.color = "var(--err)";
                    btnStep.disabled = true;
                    document.getElementById('statusText').innerText = "Error en la compilación.";
                    return;
                }

                if (data.status === 'ok') {
                    logDiv.innerText = "Compilación Exitosa!\n\n" + (data.compiler_out || "");
                    logDiv.style.color = "var(--success)";
                    loadAssemblyView(data.instructions || []);
                    highlightLine(data.ip || 0);
                    btnStep.disabled = false;
                    document.getElementById('statusText').innerText = "ASM Generado. Listo para ejecutar.";
                    document.getElementById('progOutput').innerText = "";
                    renderRegisters({});
                    renderMemory({}, 2000, 2000);
                } else if (data.status === 'compile_error') {
                    logDiv.innerText = "Error de Compilación:\n" + (data.stderr || "") + "\n" + (data.stdout || "");
                    logDiv.style.color = "var(--err)";
                    btnStep.disabled = true;
                    document.getElementById('statusText').innerText = "Falló la compilación.";
                } else {
                    logDiv.innerText = "Error: " + (data.msg || JSON.stringify(data));
                    btnStep.disabled = true;
                    document.getElementById('statusText').innerText = "Error";
                }
            } catch (e) {
                logDiv.innerText = "Error de conexión con el backend: " + e;
                document.getElementById('statusText').innerText = "Error conexión";
            }
        }
        async function step() {
            const btnStep = document.getElementById('btnStep');
            try{
                const res = await fetch('/step', { method: 'POST' });
                const data = await res.json();
                
                if (data.finished) {
                    document.getElementById('statusText').innerText = "Fin del programa.";
                    btnStep.disabled = true;
                }

                highlightLine(data.ip);
                renderRegisters(data.registers || {});

                const regs = data.registers || {};
                const rbp = regs.rbp !== undefined ? regs.rbp : 2000;
                const rsp = regs.rsp !== undefined ? regs.rsp : 2000;
                renderMemory(data.memory || {}, rsp, rbp);
                
                const outDiv = document.getElementById('progOutput');
                outDiv.innerHTML = (data.logs || []).map(x => String(x)).join('<br>');
        } catch(e) {
                console.error("Error en step:", e);
                document.getElementById('compilerLog').innerText = "Error en /step: " + e;
            }
        }

        function loadAssemblyView(instructions) {
            const container = document.getElementById('asmContainer');
            container.innerHTML = '';
            instructions.forEach((line, idx) => {
                const div = document.createElement('div');
                div.className = 'instruction';
                div.id = 'line-' + idx;
                div.innerText = `${idx}\t${line}`;
                container.appendChild(div);
            });
        }

        function highlightLine(ip) {
            document.querySelectorAll('.instruction').forEach(el => el.classList.remove('active'));
            const el = document.getElementById('line-' + ip);
            if(el) {
                el.classList.add('active');
                el.scrollIntoView({block: 'center', behavior: 'smooth'});
            }
        }

        function renderRegisters(newRegs) {
            const tbody = document.querySelector('#regTable tbody');
            tbody.innerHTML = '';
            const priority = ['rax', 'rbx', 'rcx', 'rdx', 'rsi', 'rdi', 'rbp', 'rsp'];
            
            priority.forEach(reg => {
                const val = newRegs[reg] !== undefined ? newRegs[reg] : 0;
                const tr = document.createElement('tr');
                const isChanged = currentRegs[reg] !== undefined && currentRegs[reg] !== val;
                
                tr.innerHTML = `
                    <td class="reg-name">%${reg}</td>
                    <td class="${isChanged ? 'changed' : ''}">${val}</td>
                `;
                tbody.appendChild(tr);
            });
            currentRegs = {...newRegs};
        }

        function renderMemory(mem, rsp, rbp) {
            const tbody = document.querySelector('#memTable tbody');
            tbody.innerHTML = '';

            rsp = typeof rsp === 'string' ? parseInt(rsp) : (rsp || 2000);
            rbp = typeof rbp === 'string' ? parseInt(rbp) : (rbp || 2000);
            
            let start = rsp - 24;
            let end = rsp + 64;

            for(let addr = start; addr <= end; addr+=8) {
                const val = mem[String(addr)] !== undefined ? mem[String(addr)] : 0;
                let tag = "";
                if(addr === rsp) tag = "⬅️ RSP";
                if(addr === rbp) tag += " ⬅️ RBP";

                const tr = document.createElement('tr');
                if(tag) tr.style.backgroundColor = "#333";
                
                tr.innerHTML = `
                    <td style="font-family: monospace; color:#888;">${addr}</td>
                    <td>${val} <span style="font-size:0.8em; color:var(--accent)">${tag}</span></td>
                `;
                tbody.appendChild(tr);
            }
        }
    </script>
</body>
</html>